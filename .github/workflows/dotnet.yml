name: .NET build and publish

on:
  workflow_call:
    inputs:
      DOCS_FOLDER:
        required: true
        type: string
      NET8:
        required: false
        type: boolean
      CHECK_FORMATTING:
        required: false
        type: boolean
        default: true
    secrets:
      NUGET_KEY:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - uses: actions/setup-dotnet@v3
      with:
        dotnet-version: |
          7.0
          8.0

    - name: Compute version and write rsp file
      run: |
        shopt -s extglob

        git fetch --tags --force  # https://github.com/actions/checkout/issues/290#issuecomment-680260080

        # 'git describe' outputs in a format like
        # 'tagName-commitCount-shortHash', and I want to turn that
        # into a legal nuget version. My tags start with 'v', so
        # let's lop that off, and change the _last_ '-' to '.'
        # (so that everything after tagName becomes part of the
        # prerelease annotation). When we're on an actual tag,
        # 'git describe' simply outputs the tag name, so the second
        # regex will not match (and sed will echo the input unchanged)
        version=$(git describe | sed s/^v// | sed -r 's/(.*)-/\1./')

        echo Version $version
        echo -p:Configuration=Release -p:Version=$version -p:ContinuousIntegrationBuild=true | tee Directory.Build.rsp

    - id: restore
      name: Restore
      run: dotnet restore && dotnet tool restore

    - id: format
      name: Check formatting
      if: ${{ inputs.CHECK_FORMATTING }}
      run: dotnet format --no-restore --verify-no-changes

    - id: build
      name: Build
      run: dotnet build --no-restore

    - id: test
      name: Test
      run: dotnet test --no-build --verbosity normal --collect:"XPlat Code Coverage" --logger trx

    - id: pack
      name: Pack
      if: ${{ !inputs.NET8 }}
      run: dotnet pack --no-build -o nupkgs

    - id: pack_net8
      name: Pack
      if: ${{ inputs.NET8 }}
      run: dotnet pack --no-build

    - id: push
      name: Push nuget packages
      if: ${{ github.ref_type == 'tag' && !inputs.NET8 }}
      run: |
        dotnet nuget push 'nupkgs/*' --source https://api.nuget.org/v3/index.json -k ${{ secrets.NUGET_KEY }}
        dotnet nuget push 'nupkgs/*' --source https://nuget.pkg.github.com/benjamin-hodgson/index.json -k ${{ github.token }}

    - id: push_net8
      name: Push nuget packages
      if: ${{ github.ref_type == 'tag' && inputs.NET8 }}
      run: |
        dotnet nuget push 'artifacts/package/release/*' --source https://api.nuget.org/v3/index.json -k ${{ secrets.NUGET_KEY }}
        dotnet nuget push 'artifacts/package/release/*' --source https://nuget.pkg.github.com/benjamin-hodgson/index.json -k ${{ github.token }}

    - name: Create Github Release
      if: ${{ github.ref_type == 'tag' && !inputs.NET8 }}
      # get most recent section of changelog for release notes
      run: cat CHANGELOG.md | sed -r '1,/^-+$/d' | sed -r '/^-+$/q' | head -n -2 | gh release create $GITHUB_REF_NAME ./nupkgs/* --verify-tag --notes-file -
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - name: Create Github Release
      if: ${{ github.ref_type == 'tag' && inputs.NET8 }}
      # get most recent section of changelog for release notes
      run: cat CHANGELOG.md | sed -r '1,/^-+$/d' | sed -r '/^-+$/q' | head -n -2 | gh release create $GITHUB_REF_NAME ./artifacts/package/release/* --verify-tag --notes-file -
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - uses: codecov/codecov-action@v3

    - name: Deploy docs
      uses: JamesIves/github-pages-deploy-action@ba1486788b0490a235422264426c45848eac35c6  # v4.4.1
      if: ${{ github.event_name != 'pull_request' && !inputs.NET8 }}
      with:
        branch: gh-pages
        folder: ${{ inputs.DOCS_FOLDER }}/bin/Release/_site
        target-folder: ${{ github.ref_name }}

    - name: Deploy docs
      uses: JamesIves/github-pages-deploy-action@ba1486788b0490a235422264426c45848eac35c6  # v4.4.1
      if: ${{ github.event_name != 'pull_request' && inputs.NET8 }}
      with:
        branch: gh-pages
        folder: artifacts/bin/${{ inputs.DOCS_FOLDER }}/release/_site
        target-folder: ${{ github.ref_name }}

    - uses: actions/upload-artifact@v3
      if: steps.pack.conclusion != 'cancelled' && steps.pack.conclusion != 'skipped'
      with:
        name: nupkgs
        path: nupkgs

    - uses: actions/upload-artifact@v3
      if: steps.pack_net8.conclusion != 'cancelled' && steps.pack_net8.conclusion != 'skipped'
      with:
        name: packages
        path: artifacts/package/release

    - uses: actions/upload-artifact@v3
      if: ${{ !inputs.NET8 }}
      with:
        name: ${{ inputs.DOCS_FOLDER }}
        path: ${{ inputs.DOCS_FOLDER }}/bin/Release/_site

    - uses: actions/upload-artifact@v3
      if: ${{ inputs.NET8 }}
      with:
        name: ${{ inputs.DOCS_FOLDER }}
        path: artifacts/bin/${{ inputs.DOCS_FOLDER }}/release/_site

    - uses: actions/upload-artifact@v3
      if: steps.test.conclusion != 'cancelled' && steps.test.conclusion != 'skipped'
      with:
        name: TestResults
        path: |
          **/TestResults/*.trx
          **/TestResults/*/coverage.cobertura.xml
