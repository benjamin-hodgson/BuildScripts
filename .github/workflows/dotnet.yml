name: .NET build and publish

on:
  workflow_call:
    inputs:
      DOCS_FOLDER:
        required: true
        type: string
    secrets:
      NUGET_KEY:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - uses: actions/checkout@v3
      with:
        repository: benjamin-hodgson/DocFXTemplate
        path: DocFXTemplate

    - name: Work around https://github.com/actions/checkout/issues/290
      if: github.ref_type == 'tag'
      run: |

    - uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: Get docfx
      run: |
        curl -LO https://github.com/dotnet/docfx/releases/download/v2.59.2/docfx.zip
        unzip docfx.zip -d docfx

    - name: Compute version and write rsp file
      run: |
        shopt -s extglob
        git fetch --tags --force  # https://github.com/actions/checkout/issues/290#issuecomment-680260080
        desc=$(git describe)
        version=${desc#v}
        echo Computed version: $version
        echo -p:Configuration=Release -p:Version=$version -p:ContinuousIntegrationBuild=true > Directory.Build.rsp

    - name: Restore nuget packages
      run: dotnet restore

    - name: Check formatting
      id: format
      run: dotnet format --no-restore --verify-no-changes --report format-report.json

    - name: Build
      run: dotnet build --no-restore

    - name: Test
      id: test
      run: dotnet test *.Tests --no-build --verbosity normal --collect:"XPlat Code Coverage" --logger trx

    - name: Pack
      run: dotnet pack --no-build -o nupkgs

    - name: Build docs
      run: mono docfx/docfx.exe ${{ inputs.DOCS_FOLDER }}/docfx.json -t ../DocFXTemplate

    - name: Deploy docs
      uses: JamesIves/github-pages-deploy-action@ba1486788b0490a235422264426c45848eac35c6  # v4.4.1
      if: github.event_name != 'pull_request'
      with:
        branch: gh-pages
        folder: ${{ inputs.DOCS_FOLDER }}/_site
        target-folder: ${{ github.ref_name }}

    - uses: codecov/codecov-action@v2

    - name: Get most recent section from changelog
      run: cat CHANGELOG.md | sed -r '1,/^-+$/d' | sed -r '/^-+$/q' | head -n -2 | tee release-notes.md

    - name: Push nuget packages
      if: github.ref_type == 'tag'
      run: |
        dotnet nuget push 'nupkgs/*' --source https://api.nuget.org/v3/index.json -k ${{ secrets.NUGET_KEY }}
        dotnet nuget push 'nupkgs/*' --source https://nuget.pkg.github.com/benjamin-hodgson/index.json -k ${{ github.token }}

    - name: Create Github Release
      uses: softprops/action-gh-release@1e07f4398721186383de40550babbdf2b84acfc5  # v0.1.14
      if: github.ref_type == 'tag'
      with:
        files: nupkgs/*
        body_path: release-notes.md
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - uses: actions/upload-artifact@v2
      with:
        name: nupkgs
        path: nupkgs

    - uses: actions/upload-artifact@v2
      with:
        name: ${{ inputs.DOCS_FOLDER }}
        path: ${{ inputs.DOCS_FOLDER }}/_site

    - uses: actions/upload-artifact@v2
      if: steps.test.conclusion != 'cancelled' && steps.test.conclusion != 'skipped'
      with:
        name: TestResults
        path: |
          **/TestResults/*.trx
          **/TestResults/*/coverage.cobertura.xml

    - uses: actions/upload-artifact@v2
      if: steps.format.conclusion != 'cancelled' && steps.format.conclusion != 'skipped'
      with:
        name: format-report.json
        path: format-report.json
